C51 COMPILER V9.51   SH88F2052_UART                                                        10/25/2014 17:55:48 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE SH88F2052_UART
OBJECT MODULE PLACED IN sh88f2052_uart.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE sh88f2052_uart.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1           /*
   2           ***************************************************************************
   3           * (c) Copyright, Shenzhen Hi-Link ElectronicTechnology co.,Ltd/HI-LINK(HK) CO.,LIMITED.
   4           * All Rights Reserved.
   5           *
   6           *Shenzhen Hi-Link ElectronicTechnology co.,Ltd/HI-LINK(HK) CO.,LIMITED
   7           *3F.5# Building,Minxing Industrial Park
   8           *MingZhi LongHua District
   9           *Shenzhen,China.
  10           *
  11           ***************************************************************************
  12           *
  13           */
  14          
  15          #include "sh88f2051_uart.h"
  16          
  17          xdata uchar uart_buf[64];
  18          uchar uart_len=0;
  19          uchar uart_tx_buf[6];
  20          uchar uart_tx_len=0;
  21          
  22          uchar UART_TX_IDLE=0;
  23          
  24          uchar delay(uchar xx)
  25           {
  26   1         uint i,j;
  27   1         for(;xx>0;xx--){
  28   2           for(i=0;i<1000;i++){
  29   3             j++;
  30   3           }
  31   2         }
  32   1         return j;
  33   1       }
  34           
  35           void mdelay(uint ms)
  36           {
  37   1         for(;ms;ms--){
  38   2           delay(1);
  39   2         }
  40   1       }
  41          
  42          /*************************************************************************************
  43          ***函数名：HLK_uart_init()
  44          ***功能：串口初始化
  45          ***参数：无
  46          ***返回：无
  47          *************************************************************************************/
  48          void HLK_uart_init(void)
  49          {
  50   1        CLKCON = CLKCON& ~(0x3<<5);    //设置系统时钟
  51   1        uart_len=0;
  52   1            //4800
  53   1        PCON=(1<<7);   //波特率加倍    SSTAT=0
  54   1        SCON=((1<<6)|(1<<5)|(1<<4));
  55   1      //  SBUF=0;
C51 COMPILER V9.51   SH88F2052_UART                                                        10/25/2014 17:55:48 PAGE 2   

  56   1        SADDR=0;
  57   1        SADEN=0;
  58   1      
  59   1      
  60   1        TR1=0;
  61   1        TMOD &= ~((1<<7)||(1<<6)||(3<<4));
  62   1        TMOD |= ((2<<4));    //8位计数器  定时器1工作在方式2
  63   1        TCON1 &= ~((1<<6)||(1<<3)||(1<<1));
  64   1        TCON1 |= ((1<<3));   //系统时钟作为定时器时钟
  65   1      
  66   1      
  67   1      //  TH1=0xff-0x08;  //115200
  68   1      //  TL1=0xff-0x08;
  69   1        TH1=256-9;  //115200
  70   1        TL1=256-9;
  71   1      
  72   1      //  TH1=256-109;  //115200
  73   1      //  TL1=256-109;
  74   1      
  75   1        TR1=1;
  76   1        ES0=1; //允许uart中断
  77   1        TI=0;
  78   1        RI=0;
  79   1        EA=1;  
  80   1      
  81   1        
  82   1      }
  83          /*************************************************************************************
  84          ***函数名：HLK_uart_read_TimeOut()
  85          ***功能：读串口数据
  86          ***参数：
  87                    date:数据存放缓存
  88                    len:可以读取的长度
  89          ***返回：数据长度
  90          *************************************************************************************/
  91          uint HLK_uart_read(uchar * date,uint len)
  92           {
  93   1         if(uart_len<len){
  94   2           mdelay(100);
  95   2         }
  96   1         if(uart_len){
  97   2           ES0=0;
  98   2           memcpy(date,uart_buf,uart_len);
  99   2           uart_len=0;
 100   2           ES0=1;
 101   2         }     
 102   1         return 0;
 103   1       }
 104          /*************************************************************************************
 105          ***函数名：HLK_uart_read_TimeOut()
 106          ***功能：读串口数据
 107          ***参数：
 108                    date:数据存放缓存
 109                    len:可以读取的长度
 110                    TimeOut:限制读取数据时间
 111          ***返回：数据长度
 112          *************************************************************************************/
 113           uint HLK_uart_read_TimeOut(uchar * date,uint len,uint TimeOut)
 114           {
 115   1         uint iret=0; //date的位置指示
 116   1         
 117   1         do{
C51 COMPILER V9.51   SH88F2052_UART                                                        10/25/2014 17:55:48 PAGE 3   

 118   2           mdelay(1);
 119   2           
 120   2             ES0=0;
 121   2           if(uart_len){  //不为0就表示有数据
 122   3            uchar x;
 123   3            if((iret+uart_len)<=len)
 124   3              x=uart_len;
 125   3            else
 126   3              x=len-iret;  //iret注定不会超过len
 127   3            
 128   3             memcpy(date+iret,uart_buf,(uint)x);
 129   3             iret+=x;
 130   3             uart_len=uart_len-x;  //去除已经copy的
 131   3           }
 132   2           ES0=1;
 133   2         }while((iret<len)&&(0 != TimeOut--));  //接收到指定长度的数据或者时间到
 134   1         
 135   1         return iret;
 136   1       }
 137           
 138          /*************************************************************************************
 139          ***函数名：HLK_uart_clear_rx()
 140          ***功能：清串口数据
 141          ***参数：无
 142          ***返回：无
 143          *************************************************************************************/
 144           void HLK_uart_clear_rx(void)
 145           {
 146   1         ES0=0;
 147   1         uart_len=0;
 148   1         ES0=1;
 149   1       }
 150          /*************************************************************************************
 151          ***函数名：HLK_strlen()
 152          ***功能：求字符串长度
 153          ***参数：字符串
 154          ***返回：无
 155          *************************************************************************************/
 156           unsigned int HLK_strlen(const char *str)
 157          {
 158   1        unsigned int i;
 159   1        for (i = 0; str[i]!= '\0'; i++)
 160   1          ;
 161   1        return i;
 162   1      }
 163          /*************************************************************************************
 164          ***函数名：print_char()
 165          ***功能：从串口打印一个字节
 166          ***参数：一个字节
 167          ***返回：无
 168          *************************************************************************************/
 169           void print_char(unsigned char v)
 170           {     
 171   1         ES0=0;
 172   1         TI=0;
 173   1         SBUF=v;
 174   1         while(0 == TI);
 175   1         TI=0;
 176   1         ES0=1;
 177   1       }
 178           
 179          /*************************************************************************************
C51 COMPILER V9.51   SH88F2052_UART                                                        10/25/2014 17:55:48 PAGE 4   

 180          ***函数名：HLK_Printf()
 181          ***功能：串口打印字符串
 182          ***参数：需要从串口输出的内容
 183          ***返回：无
 184          *************************************************************************************/
 185          void HLK_Printf(char *str)
 186          {
 187   1        unsigned char len=HLK_strlen(str);
 188   1        while(len--){
 189   2           print_char(*(str++));
 190   2         }
 191   1      } 
 192          /*************************************************************************************
 193          ***函数名：UART_int()
 194          ***功能：串口接收中断函数
 195          ***参数：无
 196          ***返回：无
 197          *************************************************************************************/
 198           void UART_int (void) interrupt 4
 199          {
 200   1       uchar x;
 201   1       
 202   1       if(RI){
 203   2         RI=0;
 204   2         x=SBUF;
 205   2         if(sizeof(uart_buf) > uart_len){
 206   3           uart_buf[uart_len++]=x;
 207   3         }
 208   2         else{
 209   3           ;
 210   3         }
 211   2       }
 212   1       
 213   1       if(TI){
 214   2         TI=0;
 215   2         if(uart_tx_len){
 216   3           UART_TX_IDLE=0;
 217   3           SBUF=uart_tx_buf[6-(uart_tx_len--)];
 218   3         }
 219   2         else{
 220   3           UART_TX_IDLE=1;
 221   3         }
 222   2       }
 223   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    475    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     64    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9      21
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
